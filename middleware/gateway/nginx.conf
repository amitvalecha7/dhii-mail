events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    upstream kernel {
        # Assuming kernel service will be added to docker-compose later, 
        # or we point to mock-orchestrator for now if kernel isn't containerized yet.
        # For this setup, we'll point to mock-orchestrator as the "kernel" proxy for now.
        server mock-orchestrator:8000;
    }

    upstream registry {
        server plugin-registry:5000;
    }

    server {
        listen 8080;
        server_name localhost;

        # Frontend (Static files or Dev Server Proxy)
        # In a real prod build, we'd serve static files here.
        # For local dev, we might proxy to the Vite dev server (host machine) or just serve a welcome page.
        location / {
            root /usr/share/nginx/html;
            index index.html;
            try_files $uri $uri/ /index.html;
        }

        # API Gateway Routes
        location /api/kernel/ {
            proxy_pass http://kernel/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/registry/ {
            proxy_pass http://registry/api/v1/plugins/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Health Check
        location /health {
            return 200 '{"status":"healthy","service":"api-gateway"}';
            add_header Content-Type application/json;
        }
    }
}
